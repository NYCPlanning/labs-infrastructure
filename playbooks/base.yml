---
- hosts: all
  become: true
  vars:
    ansible_python_interpreter: /usr/bin/python3
    users:
      - afeld
      - allthesignals
      - andycochran
      - chriswhong
    former_users: []
  roles:
    - role: andrewsomething.do-agent
    - role: jnv.unattended-upgrades
  handlers:
    - name: Restart SSH
      service:
        name: sshd
        state: restarted
    - name: Restart Docker
      service:
        name: docker
        state: restarted
  tasks:
    - name: User management
      block:
        - name: Set up users
          include_tasks: ../tasks/user.yml
          loop: "{{ users }}"
        - name: Remove former users
          user:
            name: "{{ item }}"
            state: absent
          loop: "{{ former_users }}"
    - name: SSH configuration
      include_tasks: ../tasks/ssh.yml
    - name: Copy in Docker config
      copy:
        src: ../files/docker-daemon.json
        dest: /etc/docker/daemon.json
      notify: Restart Docker
